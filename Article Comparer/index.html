<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docx文件对比工具</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome (使用cdnjs CDN) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 配置Tailwind主题 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6b7280',
                        accent: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        light: '#f3f4f6',
                        dark: '#1f2937'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- 自定义工具类 -->
     <style type="text/tailwindcss">
         @layer utilities {
             .content-auto {
                 content-visibility: auto;
             }
             .file-drop-active {
                 @apply border-primary bg-blue-50 shadow-lg;
             }
             .compare-panel {
                 @apply h-[60vh] overflow-y-auto border rounded-lg p-4 bg-white;
             }
             .btn-primary {
                 @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-primary/50;
             }
             .btn-primary:disabled {
                 @apply bg-gray-300 cursor-not-allowed hover:translate-y-0 hover:shadow-md;
             }
             .btn-secondary {
                 @apply bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-secondary/50;
             }
             .btn-secondary:disabled {
                 @apply bg-gray-300 cursor-not-allowed hover:translate-y-0;
             }
             .btn-accent {
                 @apply bg-accent hover:bg-accent/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-accent/50;
             }
             .btn-accent:disabled {
                 @apply bg-gray-300 cursor-not-allowed hover:translate-y-0;
             }
             .btn-danger {
                 @apply bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-danger/50;
             }
             .file-input-wrapper {
                 @apply border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition-all duration-300 hover:border-primary hover:shadow-md;
             }
             .file-input-wrapper.active {
                 @apply border-primary bg-blue-50;
             }
             .file-info {
                 @apply mt-2 text-sm text-gray-600 flex items-center justify-between;
             }
             .modified-text {
                 @apply font-bold line-through text-red-600;
             }
             .added-text {
                 @apply font-bold text-green-600;
             }
             .result-container {
                 @apply overflow-y-auto max-h-[500px] p-4 bg-white rounded-lg shadow-md border border-gray-200;
             }
             /* 表格样式 */
             .compare-panel table {
                 width: 100%;
                 border-collapse: collapse;
                 margin: 10px 0;
                 font-size: 14px;
             }
             .compare-panel th,
             .compare-panel td {
                 border: 1px solid #ddd;
                 padding: 8px;
                 text-align: left;
                 vertical-align: top;
             }
             .compare-panel th {
                 background-color: #f5f5f5;
                 font-weight: bold;
             }
         }
     </style>
     <!-- 额外的全局样式 -->
     <style>
         .modified-text {
             /* 确保删除线整体连续覆盖 */
             text-decoration-line: line-through;
             text-decoration-style: solid;
             text-decoration-color: currentColor;
             text-decoration-thickness: 2px;
         }
     </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen">
    <!-- 头部 -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary">Docx文件对比工具</h1>
            <div class="text-sm text-gray-500">
                <i class="fa fa-file-text-o mr-1"></i> Beta 1.0
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 文件上传区域 -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4">上传文件</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 基准文件上传 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa fa-file-word-o mr-1"></i> 基准文件 (左边)
                    </label>
                    <div id="baseFileDrop" class="file-input-wrapper">
                        <input type="file" id="baseFileInput" accept=".docx" class="hidden" />
                        <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1">拖放或点击选择文件</p>
                        <p class="text-xs text-gray-500">仅支持 .docx 格式</p>
                        <div id="baseFileInfo" class="file-info hidden">
                            <span id="baseFileName"></span>
                            <button id="removeBaseFile" class="text-red-500 hover:text-red-700">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 对比文件上传 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa fa-file-word-o mr-1"></i> 对比文件 (右边)
                    </label>
                    <div id="compareFileDrop" class="file-input-wrapper">
                        <input type="file" id="compareFileInput" accept=".docx" class="hidden" />
                        <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-1">拖放或点击选择文件</p>
                        <p class="text-xs text-gray-500">仅支持 .docx 格式</p>
                        <div id="compareFileInfo" class="file-info hidden">
                            <span id="compareFileName"></span>
                            <button id="removeCompareFile" class="text-red-500 hover:text-red-700">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 操作按钮区域 -->
        <section class="mb-8">
            <div class="flex flex-wrap gap-4">
                <button id="compareButton" class="btn-primary" disabled>
                    <i class="fa fa-exchange mr-2"></i> 对比文件
                </button>
                <button id="markBaseChanges" class="btn-secondary" disabled>
                    <i class="fa fa-strikethrough mr-2"></i> 标记基准文件修改
                </button>
                <button id="markCompareChanges" class="btn-accent" disabled>
                    <i class="fa fa-bold mr-2"></i> 标记对比文件修改
                </button>
                <div class="ml-auto flex flex-wrap gap-2">
                    <!-- 基准文件下载按钮 -->
                    <button id="downloadBaseDocx" class="btn-secondary" disabled>
                        <i class="fa fa-file-word-o mr-2"></i> 下载基准.docx
                    </button>
                    <button id="downloadBasePdf" class="btn-secondary" disabled>
                        <i class="fa fa-file-pdf-o mr-2"></i> 下载基准.pdf
                    </button>
                    <!-- 对比文件下载按钮 -->
                    <button id="downloadCompareDocx" class="btn-secondary" disabled>
                        <i class="fa fa-file-word-o mr-2"></i> 下载对比.docx
                    </button>
                    <button id="downloadComparePdf" class="btn-secondary" disabled>
                        <i class="fa fa-file-pdf-o mr-2"></i> 下载对比.pdf
                    </button>
                </div>
            </div>
        </section>

        <!-- 对比结果显示区域 -->
        <section id="resultSection" class="hidden">
            <h2 class="text-2xl font-bold mb-6 text-center">对比结果</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 基准文件显示 -->
                <div class="result-panel">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">基准文件</h3>
                        <span id="baseFileStatus" class="text-sm text-gray-500">未标记</span>
                    </div>
                    <div id="baseFileDisplay" class="compare-panel">
                        <!-- 原始内容 -->
                        <div id="baseFileRawContent" class="mb-4">
                            <p class="text-sm text-gray-500 mb-2">原始内容：</p>
                            <div class="text-sm whitespace-pre-wrap"></div>
                        </div>
                        <!-- 标记内容 -->
                        <div id="baseFileMarkedContent">
                            <p class="text-sm text-gray-500 mb-2">标记内容：</p>
                            <div class="text-sm whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 对比文件显示 -->
                <div class="result-panel">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">对比文件</h3>
                        <span id="compareFileStatus" class="text-sm text-gray-500">未标记</span>
                    </div>
                    <div id="compareFileDisplay" class="compare-panel">
                        <!-- 原始内容 -->
                        <div id="compareFileRawContent" class="mb-4">
                            <p class="text-sm text-gray-500 mb-2">原始内容：</p>
                            <div class="text-sm whitespace-pre-wrap"></div>
                        </div>
                        <!-- 标记内容 -->
                        <div id="compareFileMarkedContent">
                            <p class="text-sm text-gray-500 mb-2">标记内容：</p>
                            <div class="text-sm whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 对比统计信息 -->
            <div id="statsSection" class="mt-6 bg-blue-50 p-4 rounded-lg">
                <h3 class="font-bold mb-2">对比统计</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="font-medium">总修改处：</span>
                        <span id="totalChanges">0</span>
                    </div>
                    <div>
                        <span class="font-medium">添加字数：</span>
                        <span id="addedWords">0</span>
                    </div>
                    <div>
                        <span class="font-medium">删除字数：</span>
                        <span id="deletedWords">0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Markdown中转功能区域 -->
        <section id="markdownSection" class="mt-8 hidden">
            <h2 class="text-2xl font-bold mb-6 text-center">Markdown格式内容</h2>
            <div class="mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg">差异标记的Markdown代码</h3>
                    <button id="downloadMarkdown" class="btn-secondary">
                        <i class="fa fa-file-code-o mr-2"></i> 下载Markdown
                    </button>
                </div>
                <div class="bg-gray-800 text-white p-4 rounded-lg overflow-x-auto">
                    <pre id="markdownContent" class="text-sm"></pre>
                </div>
            </div>
        </section>
    </main>

    <!-- 加载动画 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
            <p id="loadingText" class="text-gray-700">处理中，请稍候...</p>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-6 mt-12">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <p class="text-gray-400 text-sm">Docx文件对比工具 &copy; 2024</p>
                <p class="text-gray-500 text-xs mt-1">支持中文、英文文档对比，精确到词语级别的差异标记</p>
            </div>
        </div>
    </footer>

    <!-- 引入所需的JavaScript库 -->
    <script src="https://unpkg.com/mammoth@latest/mammoth.browser.min.js"></script>
    <script src="js/diff.min.js/diff.min.js"></script>
    
    <!-- 使用更可靠的CDN链接并添加加载检测 -->
    <script src="https://unpkg.com/docx@7.7.0/build/index.js"></script>
    <!-- PDF生成库 - 保留原有的作为备选 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- 高质量PDF生成库 -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <!-- 中文支持 -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

    <!-- 中文字体支持 - 使用思源字体 -->
    <script src="https://cdn.jsdelivr.net/gh/xiangyuekan/jspdf-fonts@1.0.0/NotoSansCJK-Regular.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/xiangyuekan/jspdf-fonts@1.0.0/NotoSansCJK-Bold.js"></script>
    <script>
        // 确保各种库正确加载
        window.docxLibraryLoaded = false;
        window.pdfLibLoaded = false;

        document.addEventListener('DOMContentLoaded', function() {
            // 给各种库一些时间加载
            setTimeout(function() {
                // 检查DOCX库
                if (window.docx) {
                    window.docxLibraryLoaded = true;
                    console.log('DOCX库加载成功');
                } else {
                    console.warn('DOCX库加载延迟，请稍等...');
                    // 尝试备用方案
                    if (typeof require !== 'undefined') {
                        try {
                            window.docx = require('docx');
                            window.docxLibraryLoaded = true;
                            console.log('通过require加载DOCX库成功');
                        } catch (e) {
                            console.error('DOCX库加载失败');
                        }
                    }
                }

                // 检查PDF相关库
                const pdfLibLoaded = typeof window.PDFLib !== 'undefined';
                const jsPdfLoaded = typeof window.jspdf !== 'undefined';

                if (jsPdfLoaded) {
                    window.pdfLibLoaded = true;
                    console.log('PDF生成库加载成功');
                } else {
                    console.warn('PDF生成库加载延迟');
                }

                // 输出所有库的加载状态
                console.log('所有库加载状态:', {
                    'docx': window.docxLibraryLoaded,
                    'html2pdf': typeof window.html2pdf !== 'undefined',
                    'PDF-lib': pdfLibLoaded,
                    'jsPDF': jsPdfLoaded
                });

            }, 2000); // 增加等待时间，确保所有库都能加载完成
        });
    </script>
    
    <!-- 主JavaScript文件 -->
    <script src="app.js"></script>
    
    <!-- 直接在HTML中实现下载功能 -->
    <script>
        // 全局变量存储文件内容
        let fileContents = {
            base: { original: '', marked: '', fileName: '基准文件', rawText: '' },
            compare: { original: '', marked: '', fileName: '对比文件', rawText: '' }
        };
        
        // 保存文件内容到全局变量
        function saveFileContents(type, originalContent, markedContent, fileName) {
            if (type === 'base' || type === 'compare') {
                // 确保有标记内容，如果没有则使用原始内容
                const finalMarkedContent = markedContent || originalContent || '';

                // 直接保存原始内容和标记内容，不做任何替换
                fileContents[type] = {
                    original: originalContent || '',
                    marked: finalMarkedContent, // 保存完整的HTML标记内容
                    fileName: fileName || (type === 'base' ? '基准文件' : '对比文件'),
                    rawText: originalContent || '' // 保存原始文本用于排版分析
                };
                console.log(`已保存${type}文件内容:`, {
                    originalLength: (originalContent || '').length,
                    markedLength: finalMarkedContent.length,
                    fileName: fileContents[type].fileName
                });

                // 打印内容预览用于调试
                console.log(`${type}文件内容预览:`, finalMarkedContent.substring(0, 200) + '...');
            }
        }
        
        // 保存Blob为文件
        function saveBlobAsFile(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // 下载为TXT文件
        function downloadAsTXT(type, event) {
            try {
                const content = fileContents[type];
                if (!content || !content.marked) {
                    alert('未找到文件内容，请先进行标记');
                    return;
                }
                
                // 创建临时元素来解析HTML
                const tempElement = document.createElement('div');
                tempElement.innerHTML = content.marked;
                
                // 直接获取文本内容，保留原始格式
                const textContent = tempElement.textContent;
                
                // 创建Blob并下载
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                saveBlobAsFile(blob, `${content.fileName}_marked.txt`);
            } catch (error) {
                console.error('下载文本文件失败:', error);
                alert('文件下载失败: ' + error.message);
            }
        }
        
        // HTML转Markdown格式，确保删除线使用<s>标签
        function htmlToMarkdown(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // 处理删除线 - 识别实际的CSS类和HTML标签
            const deletedElements = tempDiv.querySelectorAll('.modified-text, .text-red-600, s, strike');
            deletedElements.forEach(el => {
                // 跳过已经处理过的元素
                if (el.tagName === 'S' || el.closest('s')) return;

                const parent = el.parentNode;
                const replacement = document.createElement('span');
                replacement.innerHTML = `<s>${el.innerHTML}</s>`;
                parent.replaceChild(replacement, el);
            });

            // 处理添加的文本 - 识别实际的CSS类
            const addedElements = tempDiv.querySelectorAll('.added-text, .text-green-600');
            addedElements.forEach(el => {
                // 跳过已经处理过的元素
                if (el.innerHTML.startsWith('**') && el.innerHTML.endsWith('**')) return;

                const parent = el.parentNode;
                const replacement = document.createElement('span');
                replacement.innerHTML = `**${el.innerHTML}**`;
                parent.replaceChild(replacement, el);
            });
            
            // 处理段落
            let markdown = tempDiv.innerHTML
                .replace(/<p[^>]*>/g, '\n\n')
                .replace(/<\/p>/g, '')
                .replace(/<br[^>]*>/g, '\n')
                .replace(/<div[^>]*>/g, '\n')
                .replace(/<\/div>/g, '')
                .replace(/<strong[^>]*>/g, '**')
                .replace(/<\/strong>/g, '**')
                .replace(/<em[^>]*>/g, '*')
                .replace(/<\/em>/g, '*')
                .replace(/&nbsp;/g, ' ')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .trim();
            
            // 确保多个空行合并为一个
            return markdown.replace(/\n{3,}/g, '\n\n');
        }

        // 生成并显示Markdown内容
        function generateMarkdown() {
            // 合并两个文件的Markdown内容
            const baseMarkdown = htmlToMarkdown(fileContents.base.marked);
            const compareMarkdown = htmlToMarkdown(fileContents.compare.marked);
            
            const fullMarkdown = `# 基准文件：${fileContents.base.fileName}
${baseMarkdown}

---

# 对比文件：${fileContents.compare.fileName}
${compareMarkdown}`;
            
            // 显示Markdown内容
            document.getElementById('markdownContent').textContent = fullMarkdown;
            document.getElementById('markdownSection').classList.remove('hidden');
            
            return fullMarkdown;
        }

        // 下载Markdown文件
        function downloadMarkdown() {
            const markdown = document.getElementById('markdownContent').textContent;
            if (!markdown) {
                alert('未找到Markdown内容，请先生成');
                return;
            }
            
            const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
            saveBlobAsFile(blob, `文件对比结果_${new Date().toLocaleDateString()}.md`);
        }

        // 添加Markdown转HTML的辅助函数（确保删除线正确显示）
        function markdownToHtml(markdown) {
            return markdown
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="added-text">$1</strong>')
                .replace(/<s>(.*?)<\/s>/g, '<s class="modified-text">$1</s>');
        }
        
        // 提取带格式的行内容
        function getFormattedLine(html, lineText) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            // 查找包含当前行文本的元素
            const elements = temp.querySelectorAll('span, div, p, s');
            for (let el of elements) {
                if (el.textContent.includes(lineText)) {
                    const isDeleted = el.classList.contains('modified-text') || 
                                    el.classList.contains('text-red-600') || 
                                    el.tagName === 'S' || el.tagName === 'STRIKE' ||
                                    el.closest('s') || el.querySelector('s');
                    const isAdded = el.classList.contains('added-text') || 
                                   el.classList.contains('text-green-600');
                    return {
                        text: lineText,
                        isMarked: isDeleted || isAdded,
                        isDeleted: isDeleted,
                        isAdded: isAdded,
                        color: isDeleted ? '#ef4444' : isAdded ? '#10b981' : '#000000'
                    };
                }
            }
            
            return { text: lineText, isMarked: false, isDeleted: false, isAdded: false, color: '#000000' };
        }
        
        // 添加HTML转DOCX的解析函数，支持表格结构
        function parseHtmlToDocx(html, type) {
            const elements = [];
            const { Paragraph, TextRun, Table, TableRow, TableCell, WidthType } = window.docx;

            // 预处理HTML：解码HTML实体并标准化空格
            let processedHtml = html
                .replace(/&nbsp;/g, ' ')  // 将非断行空格转换为普通空格
                .replace(/&amp;/g, '&')    // 解码其他HTML实体
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'");

            // 创建临时元素来解析HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = processedHtml;

            // 递归处理所有子元素
            function processElements(parentNode) {
                const result = [];

                for (const child of parentNode.childNodes) {
                    if (child.nodeType === Node.ELEMENT_NODE) {
                        const tagName = child.tagName.toLowerCase();

                        if (tagName === 'table') {
                            // 处理表格
                            const tableElement = processTableElement(child);
                            if (tableElement) {
                                result.push(tableElement);
                            }
                        } else if (['p', 'div', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) {
                            // 处理段落
                            const paragraph = processParagraphElement(child);
                            if (paragraph) {
                                result.push(paragraph);
                            }
                        } else if (tagName === 'br') {
                            // 处理换行
                            result.push(new Paragraph({ children: [new TextRun({ text: "", break: 1 })] }));
                        } else {
                            // 递归处理其他元素
                            const childElements = processElements(child);
                            result.push(...childElements);
                        }
                    }
                }

                return result;
            }

            // 处理表格元素
            function processTableElement(tableElement) {
                const rows = [];
                const tableRows = tableElement.querySelectorAll('tr');

                tableRows.forEach(rowElement => {
                    const cells = [];
                    const tableCells = rowElement.querySelectorAll('td, th');

                    tableCells.forEach(cellElement => {
                        const cellRuns = [];
                        processNode(cellElement, cellRuns);

                        cells.push(new TableCell({
                            children: [new Paragraph({ children: cellRuns })],
                            width: { size: 100 / tableCells.length, type: WidthType.PERCENTAGE },
                            borders: {
                                top: { style: 'single', size: 1 },
                                left: { style: 'single', size: 1 },
                                bottom: { style: 'single', size: 1 },
                                right: { style: 'single', size: 1 }
                            }
                        }));
                    });

                    if (cells.length > 0) {
                        rows.push(new TableRow({ children: cells }));
                    }
                });

                if (rows.length > 0) {
                    return new Table({
                        rows: rows,
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        borders: {
                            top: { style: 'single', size: 1 },
                            left: { style: 'single', size: 1 },
                            bottom: { style: 'single', size: 1 },
                            right: { style: 'single', size: 1 }
                        }
                    });
                }

                return null;
            }

            // 处理段落元素
            function processParagraphElement(element) {
                const runs = [];
                processNode(element, runs);

                if (runs.length > 0) {
                    return new Paragraph({
                        children: runs,
                        spacing: {
                            after: 200,
                            line: 480
                        }
                    });
                }

                return null;
            }

            // 获取所有元素
            const processedElements = processElements(tempDiv);
            elements.push(...processedElements);

            // 如果没有找到任何元素，创建一个默认段落
            if (elements.length === 0) {
                const runs = [];
                processNode(tempDiv, runs);
                if (runs.length > 0) {
                    elements.push(new Paragraph({
                        children: runs,
                        spacing: {
                            after: 200,
                            line: 480
                        }
                    }));
                }
            }

            return elements;
        }

        // 递归处理DOM节点，提取文本和格式
        function processNode(node, runs, currentFormat = {}) {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent;
                // 保留所有文本内容，包括空格，但跳过完全空的文本节点
                if (text.length > 0) {
                    runs.push(createTextRun(
                        text,
                        currentFormat.isDeleted || false,
                        currentFormat.isAdded || false,
                        currentFormat.isBold || false
                    ));
                }
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                const newFormat = { ...currentFormat };

                // 检查当前元素的格式
                if (node.classList.contains('text-red-600') || node.classList.contains('modified-text') || node.tagName === 'S' || node.tagName === 'STRIKE') {
                    newFormat.isDeleted = true;
                }
                if (node.classList.contains('text-green-600') || node.classList.contains('added-text')) {
                    newFormat.isAdded = true;
                }
                if (node.tagName === 'STRONG' || node.tagName === 'B') {
                    newFormat.isBold = true;
                }

                // 处理子节点
                for (const child of node.childNodes) {
                    processNode(child, runs, newFormat);
                }
            }
        }
        
        // 创建文本运行对象的辅助函数
        function createTextRun(text, isDeleted, isAdded, isBold = false) {
            const { TextRun } = window.docx;
            return new TextRun({
                text: text,
                bold: isAdded || isBold,
                strike: isDeleted,
                color: isDeleted ? '#ef4444' : isAdded ? '#10b981' : '#000000',
                preserveSpace: true  // 保留所有空格字符
            });
        }

        // 将DOCX元素转换为Word风格的HTML
        function convertDocxToWordStyleHtml(docElements, fileName) {
            let html = '';

            console.log('开始转换DOCX元素，元素数量:', docElements.length);

            // 添加标题
            html += `<h1 style="text-align: center; margin-bottom: 24pt; font-size: 16pt; font-weight: bold; color: #000000; page-break-after: avoid;">${fileName} - 差异标记</h1>`;

            // 处理每个DOCX元素
            docElements.forEach((element, index) => {
                console.log(`处理元素 ${index}:`, element.constructor.name);

                if (element.constructor && element.constructor.name === 'Paragraph') {
                    const paraHtml = convertDocxParagraphToHtml(element);
                    console.log(`段落 ${index} HTML:`, paraHtml.substring(0, 100));
                    html += paraHtml;
                } else if (element.constructor && element.constructor.name === 'Table') {
                    const tableHtml = convertDocxTableToHtml(element);
                    console.log(`表格 ${index} HTML:`, tableHtml.substring(0, 100));
                    html += tableHtml;
                } else {
                    console.log(`未知元素类型:`, element);
                    // 尝试直接处理为段落
                    if (typeof element === 'object' && element.children) {
                        html += `<p style="margin: 0 0 10pt 0; font-size: 11pt; line-height: 1.15;">${JSON.stringify(element)}</p>`;
                    }
                }
            });

            console.log('最终HTML长度:', html.length);
            return html;
        }

        // 转换DOCX段落为HTML - 简化版本
        function convertDocxParagraphToHtml(paragraph) {
            let textContent = '';

            console.log('转换段落:', paragraph);

            // 简化处理：直接获取段落的所有文本内容
            if (paragraph.children && Array.isArray(paragraph.children)) {
                paragraph.children.forEach((child, index) => {
                    console.log(`处理段落子元素 ${index}:`, child.constructor.name, child);

                    if (child.constructor.name === 'TextRun') {
                        if (child.text) {
                            let style = '';
                            if (child.bold) style += 'font-weight: bold; ';
                            if (child.strike) style += 'text-decoration: line-through; color: #ef4444; ';
                            if (child.color && child.color !== '#000000') style += `color: ${child.color}; `;

                            if (style) {
                                textContent += `<span style="${style}">${escapeHtml(child.text)}</span>`;
                            } else {
                                textContent += escapeHtml(child.text);
                            }
                        }
                    } else if (child.text) {
                        // 直接处理文本
                        textContent += escapeHtml(child.text);
                    } else if (typeof child === 'string') {
                        textContent += escapeHtml(child);
                    }
                });
            } else if (paragraph.text) {
                textContent = escapeHtml(paragraph.text);
            } else if (typeof paragraph === 'string') {
                textContent = escapeHtml(paragraph);
            }

            console.log('段落最终内容:', textContent.substring(0, 100));

            // 创建Word风格的段落
            return `<p style="margin: 0 0 10pt 0; text-align: left; line-height: 1.15; font-size: 11pt; page-break-inside: avoid;">${textContent}</p>`;
        }

        // 转换DOCX表格为HTML
        function convertDocxTableToHtml(table) {
            let tableHtml = '<table style="width: 100%; border-collapse: collapse; margin: 12pt 0;">';

            if (table.rows && table.rows.length > 0) {
                table.rows.forEach((row, rowIndex) => {
                    tableHtml += '<tr>';

                    if (row.cells && row.cells.length > 0) {
                        row.cells.forEach(cell => {
                            let cellText = '';
                            let cellStyle = 'border: 1px solid #000000; padding: 4pt; text-align: left; font-size: 11pt; vertical-align: top;';

                            // 解析单元格内容
                            if (cell.children && cell.children.length > 0) {
                                cell.children.forEach(child => {
                                    if (child.constructor.name === 'Paragraph') {
                                        cellText += convertDocxParagraphToHtml(child);
                                    } else if (child.constructor.name === 'TextRun' && child.text) {
                                        let style = '';
                                        if (child.bold) style += 'font-weight: bold; ';
                                        if (child.strike) style += 'text-decoration: line-through; text-decoration-color: #ef4444; ';
                                        if (child.color && child.color !== '#000000') style += `color: ${child.color}; `;

                                        if (style) {
                                            cellText += `<span style="${style}">${escapeHtml(child.text)}</span>`;
                                        } else {
                                            cellText += escapeHtml(child.text);
                                        }
                                    }
                                });
                            }

                            tableHtml += `<td style="${cellStyle}">${cellText}</td>`;
                        });
                    }

                    tableHtml += '</tr>';
                });
            }

            tableHtml += '</table>';
            return tableHtml;
        }

        // HTML转义函数
        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

  
        // 下载为DOCX文件
        function downloadAsDOCX(type) {
            try {
                const content = fileContents[type];
                if (!content || (!content.marked && !content.original)) {
                    alert('未找到文件内容，请先进行标记');
                    return;
                }

                // 检查docx库是否已加载，增加重试机制
                if (!window.docx) {
                    // 尝试等待片刻再检查
                    alert('DOCX生成库正在加载，请稍等片刻后重试');
                    // 主动检查并加载docx库
                    if (typeof docx !== 'undefined') {
                        window.docx = docx;
                    }
                    return;
                }

                // 确保所有需要的组件都可用
                const requiredComponents = ['Document', 'Packer', 'Paragraph', 'TextRun', 'Table', 'TableRow', 'TableCell', 'WidthType'];
                const docx = window.docx;
                let missingComponents = [];

                requiredComponents.forEach(comp => {
                    if (!docx[comp]) {
                        missingComponents.push(comp);
                    }
                });

                if (missingComponents.length > 0) {
                    console.warn('缺少DOCX组件:', missingComponents);
                    alert('DOCX生成库组件不完整，请刷新页面重试');
                    return;
                }

                const { Document, Packer } = docx;

                // 直接使用HTML内容进行处理
                const docContent = parseHtmlToDocx(content.marked, type);

                // 创建文档
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: `${content.fileName} - 差异标记`,
                                        bold: true,
                                        size: 24
                                    })
                                ],
                                alignment: 'center'
                            }),
                            new docx.Paragraph({
                                children: [new docx.TextRun({ text: '', break: 1 })]
                            }),
                            // 直接使用解析后的HTML内容
                            ...docContent
                        ]
                    }]
                });

                // 生成并下载文档
                Packer.toBlob(doc).then(blob => {
                    saveBlobAsFile(blob, `${content.fileName}_marked.docx`);
                });
            } catch (error) {
                console.error('下载DOCX文件失败:', error);
                alert('DOCX文件下载失败: ' + error.message);
            }
        }
        
        // 下载为PDF文件 - 高质量版本，模拟Office另存为PDF的效果
        function downloadAsPDF(type) {
            try {
                console.log('开始生成高质量PDF，类型:', type);

                const content = fileContents[type];
                if (!content) {
                    alert('未找到文件内容，请先进行标记');
                    return;
                }

                // 检查是否有标记内容或原始内容
                const contentToUse = content.marked || content.original || content.rawText;
                if (!contentToUse) {
                    alert('文件内容为空，无法生成PDF');
                    return;
                }

                console.log('内容长度:', contentToUse.length);

                // 尝试使用新的高质量PDF生成方法
                if (window.pdfLibLoaded !== false && generateHighQualityPDF(type, content, contentToUse)) {
                    return; // 成功使用新方法
                }

                // 回退到原有的html2pdf方法
                console.log('回退到html2pdf方法');
                downloadAsPDFOldMethod(type, content, contentToUse);

            } catch (error) {
                console.error('下载PDF失败:', error);
                alert('PDF下载失败: ' + error.message);
            }
        }

        // 检查PDF-lib库加载状态
        function checkPdfLibraries() {
            const pdfLibLoaded = typeof window.PDFLib !== 'undefined';
            const jsPdfLoaded = typeof window.jspdf !== 'undefined';

            console.log('PDF库加载状态:', {
                'PDF-lib': pdfLibLoaded,
                'jsPDF': jsPdfLoaded,
                'html2pdf': typeof window.html2pdf !== 'undefined'
            });

            return { pdfLibLoaded, jsPdfLoaded };
        }

        // 高质量PDF生成 - 基于DOCX结构，支持中文和优化换行
        function generateHighQualityPDF(type, content, htmlContent) {
            try {
                console.log('开始基于DOCX结构生成高质量PDF');

                showLoading('正在生成高质量PDF...');

                // 使用优化的html2pdf方法，专门处理中文和换行
                return generatePDFFromHtmlWithBetterFormatting(content, htmlContent);

            } catch (error) {
                console.error('高质量PDF生成失败:', error);
                hideLoading();
                return false;
            }
        }

        // 最基础的PDF生成方法，使用现有的DOM元素
        function generatePDFFromHtmlWithBetterFormatting(content, htmlContent) {
            try {
                console.log('=== 开始最基础的PDF生成 ===');
                console.log('内容长度:', htmlContent?.length || 'null');
                console.log('文件名:', content?.fileName || 'null');

                // 创建带有特殊CSS样式的HTML内容
                const styledHtmlContent = createSimplePdfHtml(htmlContent, content.fileName || '文件');

                // 创建临时元素来承载带样式的内容
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = styledHtmlContent;
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.top = '-9999px';
                document.body.appendChild(tempDiv);

                const contentElement = tempDiv.querySelector('div > div:last-child'); // 获取内容区域

                // 使用优化的html2pdf配置，确保删除线正确显示
                const opt = {
                    margin: [10, 10, 10, 10], // [top, right, bottom, left]
                    filename: `${(content.fileName || '文件')}_marked.pdf`,
                    image: { type: 'jpeg', quality: 0.8 },
                    html2canvas: {
                        scale: 2, // 提高分辨率，确保删除线清晰
                        useCORS: true,
                        logging: true, // 开启日志查看问题
                        backgroundColor: '#ffffff',
                        removeContainer: false,
                        letterRendering: true, // 启用字母渲染，确保文本装饰正确
                        allowTaint: false,
                        foreignObjectRendering: false,
                        scrollX: 0,
                        scrollY: 0,
                        windowWidth: document.documentElement.offsetWidth
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait',
                        compress: true,
                        precision: 16
                    }
                };

                console.log('PDF配置:', opt);

                // 生成PDF
                window.html2pdf()
                    .from(contentElement)
                    .set(opt)
                    .save()
                    .then(() => {
                        console.log('=== PDF生成成功 ===');
                    })
                    .catch(error => {
                        console.error('=== PDF生成失败 ===', error);
                        alert('PDF生成失败: ' + error.message + ' 尝试使用DOCX格式下载');
                    })
                    .finally(() => {
                        hideLoading();
                        // 清理临时元素
                        if (document.body.contains(tempDiv)) {
                            document.body.removeChild(tempDiv);
                        }
                    });

                return true;

            } catch (error) {
                console.error('基础PDF生成出错:', error);
                hideLoading();
                // 清理临时元素
                if (document.body.contains(tempDiv)) {
                    document.body.removeChild(tempDiv);
                }
                return false;
            }
        }

        // 备用方法：使用最简单的HTML内容
        function generatePDFWithBasicContent(content, htmlContent) {
            console.log('=== 使用备用PDF生成方法 ===');

            // 创建最简单的HTML内容
            const basicHtml = `
                <div style="font-family: Arial, sans-serif; padding: 20px; font-size: 12px; line-height: 1.5;">
                    <h2 style="text-align: center; margin-bottom: 20px;">${escapeHtml(content.fileName || '文件')} - 差异标记</h2>
                    <hr style="margin: 20px 0;">
                    <div style="margin: 10px 0;">
                        ${htmlContent || '暂无内容'}
                    </div>
                    <hr style="margin: 20px 0;">
                    <div style="text-align: center; font-size: 10px; color: #666;">
                        生成时间: ${new Date().toLocaleString('zh-CN')}
                    </div>
                </div>
            `;

            console.log('基本HTML长度:', basicHtml.length);

            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = 'position: absolute; top: -10000px; left: -10000px; width: 210mm;';
            tempDiv.innerHTML = basicHtml;
            document.body.appendChild(tempDiv);

            const opt = {
                margin: 0,
                filename: `${(content.fileName || '文件')}_marked.pdf`,
                html2canvas: { scale: 1, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            window.html2pdf()
                .from(tempDiv)
                .set(opt)
                .save()
                .then(() => {
                    console.log('备用PDF生成成功');
                })
                .catch(error => {
                    console.error('备用PDF生成失败:', error);
                    alert('PDF生成失败，请使用DOCX格式下载');
                })
                .finally(() => {
                    if (document.body.contains(tempDiv)) {
                        document.body.removeChild(tempDiv);
                    }
                    hideLoading();
                });

            return true;
        }

        
        
    
        // 原有的PDF生成方法作为备选
        function downloadAsPDFOldMethod(type, content, contentToUse) {
            // 确保html2pdf库已加载
            if (!window.html2pdf) {
                alert('PDF生成库未加载，请刷新页面重试');
                return;
            }

            // 创建与DOCX一致的简单HTML结构
            const pdfHtml = createSimplePdfHtml(contentToUse, content.fileName || '文件');
            console.log('生成的PDF HTML长度:', pdfHtml.length);

            // 创建临时元素
            const tempDiv = document.createElement('div');
            tempDiv.id = 'pdf-temp-' + Date.now();
            tempDiv.style.cssText = `
                position: absolute;
                top: -10000px;
                left: -10000px;
                width: 210mm;
                background: white;
                font-family: 'Times New Roman', serif;
                font-size: 11pt;
                line-height: 1.15;
                color: #000000;
                z-index: -9999;
            `;
            tempDiv.innerHTML = pdfHtml;
            document.body.appendChild(tempDiv);

            try {
                // 优化的PDF配置，更接近Office效果
                const opt = {
                    margin: {
                        top: 25,
                        right: 25,
                        bottom: 25,
                        left: 25
                    },
                    filename: `${(content.fileName || '文件')}_marked.pdf`,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: {
                        scale: 2, // 提高分辨率
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        removeContainer: true,
                        letterRendering: true,
                        allowTaint: true
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait',
                        compress: true,
                        precision: 16
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // 生成PDF
                window.html2pdf()
                    .from(tempDiv)
                    .set(opt)
                    .save()
                    .then(() => {
                        console.log('PDF生成成功');
                    })
                    .catch(error => {
                        console.error('PDF生成失败:', error);
                        alert('PDF生成失败: ' + error.message + ' 请尝试使用DOCX格式下载');
                    })
                    .finally(() => {
                        // 清理资源
                        if (document.body.contains(tempDiv)) {
                            document.body.removeChild(tempDiv);
                        }
                    });

            } catch (error) {
                console.error('PDF生成过程中出错:', error);
                alert('PDF生成出错: ' + error.message + ' 请尝试使用DOCX格式下载');
                if (document.body.contains(tempDiv)) {
                    document.body.removeChild(tempDiv);
                }
            }
        }

        // 创建简单的PDF HTML结构，与DOCX保持一致，保留格式标记
        function createSimplePdfHtml(htmlContent, fileName) {
            console.log('开始创建PDF HTML，输入内容长度:', htmlContent.length);
            console.log('输入内容预览:', htmlContent.substring(0, 200) + '...');

            // 如果内容为空或只有空白字符
            if (!htmlContent || htmlContent.trim().length === 0) {
                console.log('检测到空内容，创建默认内容');
                htmlContent = '<p>暂无内容</p>';
            }

            // 创建临时元素来处理HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            // 提取文本内容并保留基本格式
            let processedContent = '';

            // 处理段落
            const paragraphs = tempDiv.querySelectorAll('p');
            if (paragraphs.length > 0) {
                paragraphs.forEach(p => {
                    const text = p.innerHTML || p.textContent || '';
                    processedContent += `<p style="margin: 0 0 8pt 0; text-align: left; line-height: 1.15;">${text}</p>`;
                });
            } else {
                // 如果没有段落，将整个内容作为一个段落
                const text = tempDiv.innerHTML || tempDiv.textContent || htmlContent;
                processedContent = `<p style="margin: 0 0 8pt 0; text-align: left; line-height: 1.15;">${text}</p>`;
            }

            // 保持原有的CSS类名，让样式表来处理删除线显示

            // 创建包装HTML，确保有足够的内边距和布局，模拟Word文档样式
            const pdfHtml = `
                <style>
                    .modified-text, .text-red-600 {
                        color: #ef4444 !important;
                        font-weight: bold !important;
                        text-decoration: line-through !important;
                        text-decoration-color: #ef4444 !important;
                        text-decoration-thickness: 2px !important;
                        display: inline !important;
                        position: relative !important;
                        border-bottom: 2px solid #ef4444 !important;
                        line-height: 1.1 !important;
                        padding-bottom: 0.2em !important;
                    }
                    .added-text, .text-green-600 {
                        color: #10b981 !important;
                        font-weight: bold !important;
                    }
                </style>
                <div style="font-family: 'Times New Roman', serif; font-size: 11pt; line-height: 1.15; color: #000000; width: 100%; min-height: 257mm; padding: 20mm; box-sizing: border-box;">
                    <!-- 页面头部 -->
                    <div style="text-align: center; margin-bottom: 30pt; page-break-after: avoid;">
                        <h1 style="font-size: 16pt; font-weight: bold; color: #000000; margin: 20pt 0;">
                            ${fileName} - 差异标记
                        </h1>
                    </div>

                    <!-- 内容区域 -->
                    <div style="margin: 20pt 0; line-height: 1.15; text-align: justify; page-break-inside: auto;">
                        ${processedContent}
                    </div>

                    <!-- 页面底部 -->
                    <div style="margin-top: 30pt; padding-top: 20pt; border-top: 1px solid #ccc; font-size: 9pt; color: #666; text-align: center; page-break-inside: avoid;">
                        <div>生成时间: ${new Date().toLocaleString('zh-CN')}</div>
                        <div style="margin-top: 5pt;">文档对比工具生成</div>
                    </div>
                </div>
            `;

            console.log('生成的PDF HTML长度:', pdfHtml.length);
            console.log('PDF HTML预览:', pdfHtml.substring(0, 300) + '...');

            return pdfHtml;
        }
        
        // 为下载按钮添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化下载按钮事件');
            
            // 基准文件下载按钮
            const baseDocxBtn = document.getElementById('downloadBaseDocx');
            const basePdfBtn = document.getElementById('downloadBasePdf');
            
            // 对比文件下载按钮
            const compareDocxBtn = document.getElementById('downloadCompareDocx');
            const comparePdfBtn = document.getElementById('downloadComparePdf');
            
            // Markdown下载按钮
            const markdownBtn = document.getElementById('downloadMarkdown');
            
            // 绑定点击事件
            if (baseDocxBtn) baseDocxBtn.addEventListener('click', () => downloadAsDOCX('base'));
            if (basePdfBtn) basePdfBtn.addEventListener('click', () => downloadAsPDF('base'));
            if (compareDocxBtn) compareDocxBtn.addEventListener('click', () => downloadAsDOCX('compare'));
            if (comparePdfBtn) comparePdfBtn.addEventListener('click', () => downloadAsPDF('compare'));
            if (markdownBtn) markdownBtn.addEventListener('click', downloadMarkdown);
            
            // 修改对比按钮事件，添加生成Markdown的逻辑
            const compareBtn = document.getElementById('compareButton');
            if (compareBtn) {
                compareBtn.addEventListener('click', function() {
                    // 原有对比逻辑执行后，添加生成Markdown的逻辑
                    setTimeout(generateMarkdown, 1000);
                });
            }
            
            console.log('下载按钮事件绑定完成');
        });
    </script>
</body>
</html>